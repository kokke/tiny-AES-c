#include <stdio.h>
#include <string.h>
#include <stdint.h>

#include "aes128cbc.h"

uint8_t key[] = { 0x2b, 0x7e, 0x15, 0x16, 0x28, 0xae, 0xd2, 0xa6, 0xab, 0xf7, 0x15, 0x88, 0x09, 0xcf, 0x4f, 0x3c };
uint8_t iv[]  = { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f };

//#define DATA_MAXLEN	146
//uint8_t str_buf[DATA_MAXLEN] = "HB=0,SN=\"00000000000\",VER=\"00.10\",PVER=\"01.00\",TYPE=\"VOICE1\",ID=\"11\",TK=\"0\",CL=\"N\",C1=\"X\",C2=\"X\",S1=\"EN\",S2=\"BN\",S3=\"EN\",S4=\"EN\",S5=\"EN\",S6=\"EN\";";
	
#define DATA_MAXLEN	(1600+2)
uint8_t str_buf[DATA_MAXLEN] = "1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890" 
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890" 
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"
";";

/*
CipherText = PlainText + 16 - (PlainText MOD 16)
http://www.obviex.com/articles/CiphertextSize.pdf
*/
#define BUFF_MAXLEN (DATA_MAXLEN+16-(DATA_MAXLEN%16))

static void prettydb(uint8_t* str, uint32_t len)
{
    uint32_t idx;
    for(idx = 0; idx < len; ++idx){
        printf("%.3u: %.2x %c", idx, str[idx], str[idx]);   
        if((idx+1)%8 == 0)		printf("\n");
        else 					printf("\t");
    }
    printf("\n");
} 

int main(void)
{
	uint8_t dat_buf[BUFF_MAXLEN];
	uint8_t encrypt_buf[BUFF_MAXLEN];
	uint8_t decrypt_buf[DATA_MAXLEN]; 	 	
	uint32_t dat_len = strlen((char*)str_buf)+1;
	uint32_t datpad_len;

	memset(dat_buf, 0, sizeof(dat_buf));
	memset(encrypt_buf, 0, sizeof(encrypt_buf));
	memset(decrypt_buf, 0, sizeof(decrypt_buf));

	datpad_len = aes128cbc_datpad(dat_buf, str_buf, strlen((char*)str_buf)+1);

	printf("dat_len: %u\n", dat_len);
	printf("datpad_len: %u\n", datpad_len);

	prettydb(dat_buf, sizeof(dat_buf));
    aes128cbc_encrypt(encrypt_buf, dat_buf, datpad_len, key, iv);
    printf("---------------------------------\n");
    prettydb(encrypt_buf, sizeof(encrypt_buf));
    printf("---------------------------------\n");

	if(1){
		aes128cbc_decrypt(decrypt_buf, encrypt_buf, datpad_len, key, iv); 
		prettydb(decrypt_buf, sizeof(decrypt_buf));
		printf("decrypt style 1: %s\n", decrypt_buf);  
	}else{
		aes128cbc_decrypt_block(decrypt_buf, encrypt_buf, datpad_len, key, iv); 
		prettydb(decrypt_buf, sizeof(decrypt_buf));
		printf("decrypt style 2: %s\n", decrypt_buf);  
	}
    return 0;
}


